<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restaurant Menu</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body { background: #fafafa; }

    .sticky-top-shadow { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .category-btn.active { border-width: 2px; }

    .subcat-strip {
      display: flex;
      gap: .75rem;
      overflow-x: auto;
      padding-bottom: .25rem;
      scroll-snap-type: x mandatory;
    }
    .subcat-strip::-webkit-scrollbar { height: 8px; }
    .subcat-strip::-webkit-scrollbar-thumb { border-radius: 10px; background: rgba(0,0,0,.15); }
    .subcat-chip { scroll-snap-align: start; white-space: nowrap; }

    .section-anchor { scroll-margin-top: 160px; } /* for sticky header spacing */

    .menu-card {
      border: 0;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }

    .item-img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #eee;
      display: block;
    }

    .price { font-weight: 700; }
  </style>
</head>

<body>
  <!-- Header / Controls -->
  <div class="sticky-top bg-white sticky-top-shadow">
    <div class="container py-3" id="top">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div>
          <h1 class="h4 mb-0">Menu</h1>
          <small class="text-muted" id="statusText">Loading…</small>
        </div>

        <div class="btn-group" role="group" aria-label="Categories">
          <button class="btn btn-outline-dark category-btn" data-category="Food">Food</button>
          <button class="btn btn-outline-dark category-btn" data-category="Drinks">Drinks</button>
          <button class="btn btn-outline-dark category-btn" data-category="Desserts">Desserts</button>
        </div>
      </div>

      <!-- Subcategory carousel strip -->
      <div class="mt-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Subcategories</div>
          <button id="scrollToTopBtn" class="btn btn-sm btn-outline-secondary">Top</button>
        </div>
        <div class="mt-2 subcat-strip" id="subcatStrip">
          <!-- chips inserted here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <main class="container py-4">
    <div id="content"></div>
  </main>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // =========================
    // CONFIG (CHANGE THESE)
    // =========================
    const SUPABASE_URL = "https://ixqtbndjbqbkapghoszx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_PAK28m8_Q4BpETQ0YWHjDg_oifolhDG";

    const TABLE_NAME = "menu_items";
    const IMAGE_BUCKET = "menu-images"; // Supabase Storage bucket name (public)

    const CATEGORIES = ["Food", "Drinks", "Desserts"];

    // =========================
    // STATE
    // =========================
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let allItems = [];
    let currentCategory = "Food";

    // =========================
    // HELPERS
    // =========================
    const el = (id) => document.getElementById(id);

    function slugify(str) {
      return String(str || "")
        .trim()
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function priceUSD(value) {
      const n = Number(value);
      if (Number.isNaN(n)) return "";
      return `$${n.toFixed(2)}`;
    }

    function groupBy(arr, keyFn) {
      const map = new Map();
      for (const item of arr) {
        const key = keyFn(item) ?? "Other";
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      }
      return map;
    }

    function sortByName(items) {
      return [...items].sort((a, b) =>
        String(a.name || "").localeCompare(String(b.name || ""))
      );
    }

    function getPublicImageUrl(image_path) {
      if (!image_path) return null;
      const res = supabase.storage.from(IMAGE_BUCKET).getPublicUrl(image_path);
      return res?.data?.publicUrl || null;
    }

    function resolveImageUrl(item) {
      // If later you prefer saving full URLs in DB, add image_url column and use it here.
      // For now we use Storage + image_path.
      if (item.image_path) return getPublicImageUrl(item.image_path);
      return null;
    }

    // =========================
    // FETCH
    // =========================
    async function fetchMenuItems() {
      el("statusText").textContent = "Loading menu from database…";

      const { data, error } = await supabase
        .from(TABLE_NAME)
        .select("id, category, subcategory, name, description, price, image_path, is_available")
        .eq("is_available", true);

      if (error) {
        console.error(error);
        el("statusText").textContent = "Failed to load menu.";
        el("content").innerHTML = `
          <div class="alert alert-danger">
            Could not load menu items. Check:
            <ul class="mb-0">
              <li>SUPABASE_URL and SUPABASE_ANON_KEY</li>
              <li>Table name: ${TABLE_NAME}</li>
              <li>RLS policy allows SELECT for anonymous (or RLS off)</li>
            </ul>
          </div>`;
        return;
      }

      allItems = data || [];
      el("statusText").textContent = "Loaded.";
    }

    // =========================
    // RENDER
    // =========================
    function renderCategoryButtons() {
      document.querySelectorAll(".category-btn").forEach(btn => {
        const cat = btn.getAttribute("data-category");
        btn.classList.toggle("active", cat === currentCategory);
      });
    }

    function renderSubcategoryStrip(subcategories) {
      const strip = el("subcatStrip");
      strip.innerHTML = "";

      if (subcategories.length === 0) {
        strip.innerHTML = `<span class="text-muted">No subcategories found.</span>`;
        return;
      }

      for (const sub of subcategories) {
        const anchorId = `${slugify(currentCategory)}-${slugify(sub)}`;

        const a = document.createElement("a");
        a.href = `#${anchorId}`;
        a.className = "btn btn-sm btn-outline-primary subcat-chip";
        a.textContent = sub;

        a.addEventListener("click", (e) => {
          e.preventDefault();
          const target = document.getElementById(anchorId);
          if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
          history.replaceState(null, "", `#${anchorId}`);
        });

        strip.appendChild(a);
      }
    }

    function renderSections(itemsForCategory) {
      const content = el("content");
      content.innerHTML = "";

      if (itemsForCategory.length === 0) {
        content.innerHTML = `
          <div class="alert alert-warning">
            No items found in <strong>${currentCategory}</strong>.
          </div>`;
        return;
      }

      const grouped = groupBy(itemsForCategory, x => x.subcategory || "Other");
      const subcats = Array.from(grouped.keys()).sort((a,b) => String(a).localeCompare(String(b)));

      for (const subcat of subcats) {
        const sectionId = `${slugify(currentCategory)}-${slugify(subcat)}`;

        const section = document.createElement("section");
        section.className = "mb-5 section-anchor";
        section.id = sectionId;

        section.innerHTML = `
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">${subcat}</h2>
            <a href="#top" class="text-decoration-none small text-muted">Back to top</a>
          </div>
          <div class="row g-3" id="grid-${sectionId}"></div>
        `;

        content.appendChild(section);

        const grid = document.getElementById(`grid-${sectionId}`);
        const itemsSorted = sortByName(grouped.get(subcat));

        for (const item of itemsSorted) {
          const imgUrl = resolveImageUrl(item);

          const col = document.createElement("div");
          col.className = "col-12 col-md-6 col-lg-4";

          col.innerHTML = `
            <div class="card menu-card h-100">
              ${
                imgUrl
                  ? `<img src="${imgUrl}" alt="${(item.name || "Menu item")}" class="item-img"
                       onerror="this.style.display='none';">`
                  : `<div class="item-img d-flex align-items-center justify-content-center text-muted">
                       No Image
                     </div>`
              }
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start gap-3">
                  <div>
                    <div class="fw-semibold">${item.name ?? ""}</div>
                    ${item.description ? `<div class="text-muted small mt-1">${item.description}</div>` : ""}
                  </div>
                  <div class="price">${priceUSD(item.price)}</div>
                </div>
              </div>
            </div>
          `;

          grid.appendChild(col);
        }
      }
    }

    function renderCurrentCategory() {
      renderCategoryButtons();

      const itemsForCategory = allItems.filter(x => String(x.category) === currentCategory);

      const grouped = groupBy(itemsForCategory, x => x.subcategory || "Other");
      const subcategories = Array.from(grouped.keys()).sort((a,b) => String(a).localeCompare(String(b)));

      renderSubcategoryStrip(subcategories);
      renderSections(itemsForCategory);
    }

    // =========================
    // EVENTS
    // =========================
    function wireEvents() {
      document.querySelectorAll(".category-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          currentCategory = btn.getAttribute("data-category");
          renderCurrentCategory();
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });

      el("scrollToTopBtn").addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    // =========================
    // INIT
    // =========================
    (async function init() {
      wireEvents();
      await fetchMenuItems();
      renderCurrentCategory();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
