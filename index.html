<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Restaurant Menu</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
  :root{
    --adi-teal:#4FB7A6;
    --adi-teal-dark:#2F8F82;
    --adi-orange:#E84A2A;
    --adi-gold:#F2B21A;
    --adi-ink:#1F2937;
    --adi-muted:#6B7280;
    --adi-bg:#F7F8FA;
    --adi-card:#FFFFFF;
    --adi-border:rgba(0,0,0,.06);
    --adi-shadow: 0 10px 28px rgba(0,0,0,.07);
  }

  body{
    background: var(--adi-bg);
    color: var(--adi-ink);
  }

  /* header */
  .sticky-top-shadow{
    box-shadow: var(--adi-shadow);
    border-bottom: 1px solid var(--adi-border);
    backdrop-filter: blur(10px);
  }

  .brandbar{
    display:flex;
    align-items:center;
    gap:.75rem;
    min-height: 56px;
  }
  .brand-logo{
    height: 44px;
    width: auto;
    display:block;
  }

  /* category buttons */
  .category-btn{
    border-radius: 999px !important;
    border-color: rgba(31,41,55,.18) !important;
    color: var(--adi-ink) !important;
    transition: transform .08s ease, background .15s ease, border-color .15s ease;
  }
  .category-btn:active{ transform: scale(.98); }

  .category-btn.active{
    background: var(--adi-teal) !important;
    border-color: var(--adi-teal) !important;
    color:#fff !important;
    box-shadow: 0 8px 18px rgba(79,183,166,.25);
  }

  /* subcategory strip */
  .subcat-strip{
    display:flex;
    gap:.6rem;
    overflow-x:auto;
    padding-bottom:.25rem;
    scroll-snap-type:x mandatory;
  }
  .subcat-strip::-webkit-scrollbar{ height: 8px; }
  .subcat-strip::-webkit-scrollbar-thumb{
    border-radius: 999px;
    background: rgba(31,41,55,.18);
  }

  .subcat-chip{
    scroll-snap-align: start;
    white-space: nowrap;
    border-radius: 999px !important;
    border: 1px solid rgba(79,183,166,.55) !important;
    color: var(--adi-teal-dark) !important;
    background: rgba(79,183,166,.06);
    transition: background .15s ease, transform .08s ease;
  }
  .subcat-chip:hover{ background: rgba(79,183,166,.12); }
  .subcat-chip:active{ transform: scale(.98); }

  .section-anchor{ scroll-margin-top: 175px; }

  /* section title */
  .section-title{
    display:flex;
    align-items:center;
    gap:.6rem;
  }
  .section-dot{
    width:10px; height:10px;
    border-radius:999px;
    background: var(--adi-gold);
    box-shadow: 0 6px 14px rgba(242,178,26,.25);
  }

  /* cards */
  .menu-card{
    border-radius: 18px;
    overflow:hidden;
    background: var(--adi-card);
    border: 1px solid var(--adi-border);
    box-shadow: 0 10px 26px rgba(0,0,0,.06);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .menu-card:hover{
    transform: translateY(-2px);
    box-shadow: 0 14px 34px rgba(0,0,0,.08);
  }

  .item-img{
    width:100%;
    height: 160px;
    object-fit: cover;
    background: #e9eef2;
    display:block;
  }

  .item-name{
     font-size: 0.95rem;
     font-weight: 700;
  }

.menu-card .card-body{
  padding: .7rem .75rem; /* smaller card */
}
.subcat-title {
  font-size: 1.15rem;    
  font-weight: 800;        
  letter-spacing: .2px;
  color: var(--adi-ink);
  margin-bottom: .75rem;
  margin-top: 1.25rem;
}





.item-desc{
  color: var(--adi-muted);
  font-size: 0.82rem;
  line-height: 1.15rem;
  margin-top: .25rem;

  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;  
  overflow: hidden;

  cursor: pointer;
  position: relative;
}





.item-desc.expanded{
  display: block;
  overflow: visible;
  -webkit-line-clamp: unset;
  -webkit-box-orient: unset;
}


.desc-more{
  display: none;
  color: var(--adi-teal-dark);
  font-weight: 600;
  font-size: 0.82rem;
  margin-left: .25rem;
}

.item-desc-wrap.truncated .desc-more{
  display: inline;
}

.item-desc-wrap.expanded .desc-more {
  display: none;
}




.price{
    font-weight: 800;
    white-space: nowrap;
    padding: .18rem .5rem;
    border-radius: 999px;
    background: rgba(242,178,26,.18);
    border: 1px solid rgba(242,178,26,.35);
    color:#7A5200;
  }

  #scrollToTopBtn{
    border-radius: 999px;
  }
</style>

</head>

<body>

  <div class="sticky-top bg-white sticky-top-shadow">
    <div class="container py-3" id="top">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="brandbar">

      <img class="brand-logo" src="assets/adi-logo.jpg" alt="ADI" />
  <div>
    <h1 class="h4 mb-0">Menu</h1>
    <small class="text-muted" id="statusText">Loading…</small>
  </div>
</div>


        <div class="d-flex flex-wrap gap-2 gap-md-3" role="group" aria-label="Categories">

          <button class="btn btn-outline-dark category-btn" data-category="Food">Food</button>
          <button class="btn btn-outline-dark category-btn" data-category="Drinks">Drinks</button>
          <button class="btn btn-outline-dark category-btn" data-category="Desserts">Desserts</button>
        </div>
      </div>

      <div class="mt-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Subcategories</div>
          <button id="scrollToTopBtn" class="btn btn-sm btn-outline-secondary">Top</button>
        </div>
        <div class="mt-2 subcat-strip" id="subcatStrip"></div>
      </div>
    </div>
  </div>

  <main class="container py-4">
    <div id="content"></div>
  </main>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>

    const SUPABASE_URL = "https://ixqtbndjbqbkapghoszx.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_PAK28m8_Q4BpETQ0YWHjDg_oifolhDG";

    const TABLE_NAME = "menu_items_csv";
    const IMAGE_BUCKET = "menu-images-test"; 


    window.__db = window.__db || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const db = window.__db;

    let allItems = [];
    let currentCategory = "Food";

  
    const el = (id) => document.getElementById(id);


    function slugify(str) {
      return String(str || "")
        .trim()
        .toLowerCase()
        .replace(/&/g, "and")
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    }

    function priceUSD(value) {
      const n = Number(value);
      if (Number.isNaN(n)) return "";
      return `$${n.toFixed(2)}`;
    }

    function groupBy(arr, keyFn) {
      const map = new Map();
      for (const item of arr) {
        const key = keyFn(item) ?? "Other";
        if (!map.has(key)) map.set(key, []);
        map.get(key).push(item);
      }
      return map;
    }

    function sortByName(items) {
      return [...items].sort((a, b) =>
        String(a.name || "").localeCompare(String(b.name || ""))
      );
    }

 function getPublicImageUrl(image_path) {
  if (!image_path) return null;

  const safePath = String(image_path)
    .trim()
    .split("/")
    .map(part => encodeURIComponent(part.trim()))
    .join("/");

  return `${SUPABASE_URL}/storage/v1/object/public/${IMAGE_BUCKET}/${safePath}`;
}


 function resolveImageUrl(item) {
  return item.image_path ? getPublicImageUrl(item.image_path) : null;
}



    async function fetchMenuItems() {
      el("statusText").textContent = "Loading menu from database…";

      const { data, error } = await db
        .from(TABLE_NAME)
        .select("id, category, subcategory, subcategory_order, name, description, price, image_path, is_available")
        .eq("is_available", true);

      if (error) {
        console.error("Supabase error:", error);
        el("statusText").textContent = "Failed to load menu.";
        el("content").innerHTML = `
          <div class="alert alert-danger">
            <div class="fw-semibold mb-2">Could not load menu items</div>
            <pre class="mb-0">${JSON.stringify(error, null, 2)}</pre>
          </div>`;
        return;
      }

      allItems = data || [];
     el("statusText").style.display = "none";

    }

document.addEventListener("click", (e) => {
  const wrap = e.target.closest(".item-desc-wrap");
  if (!wrap) return;

  const desc = wrap.querySelector(".item-desc");
  if (!desc) return;

  desc.classList.toggle("expanded");
  wrap.classList.toggle("expanded");
});


function markTruncatedDescriptions() {
  requestAnimationFrame(() => {
    document.querySelectorAll(".item-desc-wrap").forEach(wrap => {
      wrap.classList.remove("truncated");

      const desc = wrap.querySelector(".item-desc");
      if (!desc) return;

      // only if the clamped preview is actually overflowing
      if (!desc.classList.contains("expanded") && desc.scrollHeight > desc.clientHeight + 1) {
        wrap.classList.add("truncated");
      }
    });
  });
}


    function renderCategoryButtons() {
      document.querySelectorAll(".category-btn").forEach(btn => {
        const cat = btn.getAttribute("data-category");
        btn.classList.toggle("active", cat === currentCategory);
      });
    }

    function renderSubcategoryStrip(subcategories) {
      const strip = el("subcatStrip");
      strip.innerHTML = "";

      if (subcategories.length === 0) {
        strip.innerHTML = `<span class="text-muted">No subcategories found.</span>`;
        return;
      }

      for (const sub of subcategories) {
        const anchorId = `${slugify(currentCategory)}-${slugify(sub)}`;

        const a = document.createElement("a");
        a.href = `#${anchorId}`;
        a.className = "btn btn-sm btn-outline-primary subcat-chip";
        a.textContent = sub;

        a.addEventListener("click", (e) => {
          e.preventDefault();
          const target = document.getElementById(anchorId);
          if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
          history.replaceState(null, "", `#${anchorId}`);
        });

        strip.appendChild(a);
      }
    }

   function renderSections(itemsForCategory) {
  const content = el("content");
  content.innerHTML = "";

  if (itemsForCategory.length === 0) {
    content.innerHTML = `
      <div class="alert alert-warning">
        No items found in <strong>${currentCategory}</strong>.
      </div>
    `;
    return;
  }

  const grouped = groupBy(itemsForCategory, x => x.subcategory || "Other");

  const subcats = Array.from(grouped.keys()).sort((a, b) => {
    const oa = Math.min(...(grouped.get(a) || []).map(x => Number(x.subcategory_order ?? 999)));
    const ob = Math.min(...(grouped.get(b) || []).map(x => Number(x.subcategory_order ?? 999)));
    if (oa !== ob) return oa - ob;
    return String(a).localeCompare(String(b));
  });

  for (const subcat of subcats) {
    const sectionId = `${slugify(currentCategory)}-${slugify(subcat)}`;

    const section = document.createElement("section");
    section.className = "mb-5 section-anchor";
    section.id = sectionId;

    section.innerHTML = `
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="subcat-title">${subcat}</h2>
      </div>
      <div class="row g-3" id="grid-${sectionId}"></div>
    `;

    content.appendChild(section);

    const grid = document.getElementById(`grid-${sectionId}`);
    const itemsSorted = sortByName(grouped.get(subcat));

    for (const item of itemsSorted) {
      const imgUrl = resolveImageUrl(item);
      const finalImgUrl = imgUrl || "./assets/placeholder.webp";

      const col = document.createElement("div");
      col.className = "col-12 col-md-6 col-lg-4";

      col.innerHTML = `
        <div class="card menu-card h-100">
          <img
            src="${finalImgUrl}"
            alt="${item.name || "Menu item"}"
            class="item-img"
            loading="lazy"
            onerror="this.onerror=null; this.src='./assets/placeholder.webp';"
          />

          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div>
                <div class="item-name fw-semibold">${item.name ?? ""}</div>
                ${
                  item.description
                    ? `
                      <div class="item-desc-wrap">
                        <span class="item-desc">${item.description}</span>
                        <span class="desc-more">more</span>
                      </div>
                    `
                    : ""
                }
              </div>
              <div class="price">${priceUSD(item.price)}</div>
            </div>
          </div>
        </div>
      `;

      grid.appendChild(col);
    }
  }

  // IMPORTANT: call after DOM is rendered
  markTruncatedDescriptions();
}


    function renderCurrentCategory() {
      renderCategoryButtons();

      // be tolerant to spaces/case so it never breaks again
      const itemsForCategory = allItems.filter(x =>
        String(x.category || "").trim().toLowerCase() === currentCategory.toLowerCase()
      );

      const grouped = groupBy(itemsForCategory, x => x.subcategory || "Other");
      const subcategories = Array.from(grouped.keys()).sort((a, b) => {
       const oa = Math.min(...(grouped.get(a) || []).map(x => Number(x.subcategory_order ?? 999)));
       const ob = Math.min(...(grouped.get(b) || []).map(x => Number(x.subcategory_order ?? 999)));
       if (oa !== ob) return oa - ob;
        return String(a).localeCompare(String(b));
      });


      renderSubcategoryStrip(subcategories);
      renderSections(itemsForCategory);
    }

  
    function wireEvents() {
      document.querySelectorAll(".category-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          currentCategory = btn.getAttribute("data-category");
          renderCurrentCategory();
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });

      el("scrollToTopBtn").addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }


    (async function init() {
      wireEvents();
      await fetchMenuItems();
      renderCurrentCategory();
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


